<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Viewer</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .entity { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        .entity-name { font-size: 20px; font-weight: bold; margin-bottom: 10px; color: #2c3e50; }
        .characteristics { margin-bottom: 15px; }
        .characteristic { display: inline-block; margin-right: 15px; color: #7f8c8d; }
        .objects { margin-top: 15px; }
        .object { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 3px; }
        .object-name { font-weight: bold; margin-bottom: 5px; }
        .value-row { display: flex; margin-bottom: 5px; }
        .value-name { width: 200px; font-weight: bold; }
        .value-unit { color: #7f8c8d; margin-left: 5px; }
        .search-box { margin-bottom: 20px; }
        #search-input { width: 300px; padding: 8px; }
        #search-results { display: none; margin-top: 20px; }
        .highlight { background-color: yellow; }
    </style>
</head>
<body>
    <div class="search-box">
        <input type="text" id="search-input" placeholder="Поиск...">
    </div>

    <div id="search-results"></div>

    <div id="all-data">
        {% for entity in entities %}
        <div class="entity">
            <div class="entity-name">{{ entity.name }}</div>

            <div class="characteristics">
                {% for char in entity.characteristics %}
                <span class="characteristic">
                    {{ char.name }}
                    {% if char.data_type %}({{ char.data_type }}){% endif %}
                    {% if char.unit %}[{{ char.unit }}]{% endif %}
                </span>
                {% endfor %}
            </div>

            <div class="objects">
                {% for obj in entity.objects %}
                <div class="object">
                    <div class="object-name">{{ obj.name }}</div>
                    {% for char in entity.characteristics %}
                    <div class="value-row">
                        <div class="value-name">{{ char.name }}:</div>
                        <div class="value-value">
                            {% if obj.characteristics_info and (char.id|string) in obj.characteristics_info %}
                                {{ obj.characteristics_info[char.id|string].value }}
                                {% if obj.characteristics_info[char.id|string].unit %}
                                    <span class="value-unit">{{ obj.characteristics_info[char.id|string].unit }}</span>
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        document.getElementById('search-input').addEventListener('input', function() {
            const query = this.value.trim();
            const resultsDiv = document.getElementById('search-results');
            const allDataDiv = document.getElementById('all-data');

            if (query.length > 0) {
                fetch(`/search?q=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.length > 0) {
                            let html = '<h3>Результаты поиска:</h3>';
                            data.forEach(item => {
                                html += `
                                    <div style="margin-bottom:15px;padding:10px;background:#f9f9f9;">
                                        <div><strong>${highlight(item.entity, query)}</strong></div>
                                        <div>${highlight(item.object, query)}</div>
                                        <div>${highlight(item.characteristic, query)}: ${highlight(item.value, query)}</div>
                                    </div>
                                `;
                            });
                            resultsDiv.innerHTML = html;
                            resultsDiv.style.display = 'block';
                            allDataDiv.style.display = 'none';
                        } else {
                            resultsDiv.innerHTML = 'Ничего не найдено';
                            resultsDiv.style.display = 'block';
                            allDataDiv.style.display = 'none';
                        }
                    });
            } else {
                resultsDiv.style.display = 'none';
                allDataDiv.style.display = 'block';
            }
        });

        function highlight(text, query) {
            if (!query || !text) return text;
            const re = new RegExp(query, 'gi');
            return text.toString().replace(re, match => `<span class="highlight">${match}</span>`);
        }
    </script>
</body>
</html>