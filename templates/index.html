{% extends "base.html" %}

{% block content %}
<div class="search-box">
    <input type="text" id="search-input" placeholder="Поиск по названиям объектов...">
</div>

<div id="search-results"></div>

<div id="all-data">
    {% for entity in entities %}
    <div class="entity">
        <div class="entity-header">
            <h2 class="entity-name">{{ entity.name }}</h2>
            <div class="entity-category">
                {{ entity.category }} / {{ entity.subcategory }}
            </div>
        </div>

        <div class="characteristics-list">
            {% for char in entity.characteristics %}
            <div class="characteristic-tag">
                <span>{{ char.name }}</span>
                {% if char.data_type %}
                <span class="type-badge">{{ char.data_type }}</span>
                {% endif %}
                {% if char.unit %}
                <span class="unit-badge">{{ char.unit }}</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <div class="objects-list">
            {% for obj in entity.objects %}
            <div class="object">
                <div class="object-header">
                    <h3 class="object-name">{{ obj.name }}</h3>
                </div>
                <div class="properties-list">
                    {% for char in entity.characteristics %}
                    <div class="property">
                        <div class="property-name">{{ char.name }}</div>
                        <div class="property-value">
                            {% if obj.characteristics_info and (char.id|string) in obj.characteristics_info %}
                                {% set value = obj.characteristics_info[char.id|string].value %}
                                {% if '...' in value %}
                                    {% set parts = value.split('...') %}
                                    <span class="range-value">{{ parts[0] }} — {{ parts[1] }}</span>
                                {% elif value.startswith('≥') %}
                                    <span class="range-value">≥ {{ value[1:] }}</span>
                                {% elif value.startswith('≤') %}
                                    <span class="range-value">≤ {{ value[1:] }}</span>
                                {% else %}
                                    {{ value }}
                                {% endif %}
                                {% if obj.characteristics_info[char.id|string].unit %}
                                    <span class="unit">{{ obj.characteristics_info[char.id|string].unit }}</span>
                                {% endif %}
                            {% else %}
                                <span class="empty-value">—</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
    document.getElementById('search-input').addEventListener('input', function() {
        const query = this.value.trim();
        const resultsDiv = document.getElementById('search-results');
        const allDataDiv = document.getElementById('all-data');

        if (query.length > 0) {
            fetch(`/search?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.length > 0) {
                        let html = '<h3>Результаты поиска:</h3>';
                        data.forEach(item => {
                            html += `
                                <div class="search-result">
                                    <p><strong>${highlight(item.entity, query)}</strong></p>
                                    <p>Объект: ${highlight(item.object, query)}</p>
                                </div>
                            `;
                        });
                        resultsDiv.innerHTML = html;
                        resultsDiv.style.display = 'block';
                        allDataDiv.style.display = 'none';
                    } else {
                        resultsDiv.innerHTML = '<p>Ничего не найдено</p>';
                        resultsDiv.style.display = 'block';
                        allDataDiv.style.display = 'none';
                    }
                });
        } else {
            resultsDiv.style.display = 'none';
            allDataDiv.style.display = 'block';
        }
    });

    function highlight(text, query) {
        if (!query || !text) return text;
        const re = new RegExp(query, 'gi');
        return text.toString().replace(re, match => `<span class="highlight">${match}</span>`);
    }
</script>
{% endblock %}